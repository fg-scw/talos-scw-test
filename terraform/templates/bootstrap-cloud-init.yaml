#cloud-config

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - jq
  - git
  - vim
  - netcat

write_files:
  - path: /root/cilium-patch.yaml
    encoding: b64
    content: ${cilium_patch}
    permissions: '0644'

  - path: /root/bootstrap-talos.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail
      
      CLUSTER_NAME="${cluster_name}"
      K8S_ENDPOINT="https://${k8s_api_endpoint}:6443"
      CONTROL_PLANE_IPS=(${control_plane_ips})
      WORKER_IPS=(${worker_ips})
      
      log() {
        echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | tee -a /var/log/talos-bootstrap.log
      }
      
      log "=========================================="
      log "Starting Talos Cluster Bootstrap"
      log "=========================================="
      log "Cluster: $CLUSTER_NAME"
      log "Endpoint: $K8S_ENDPOINT"
      log "Control Planes: $${CONTROL_PLANE_IPS[@]}"
      log "Workers: $${WORKER_IPS[@]}"
      
      log "Waiting for nodes to be reachable..."
      for ip in "$${CONTROL_PLANE_IPS[@]}" "$${WORKER_IPS[@]}"; do
        log "  Checking $ip:50000..."
        timeout=300
        elapsed=0
        while ! nc -z -w5 "$ip" 50000; do
          if [ $elapsed -ge $timeout ]; then
            log "ERROR: Timeout waiting for $ip:50000"
            exit 1
          fi
          sleep 5
          elapsed=$((elapsed + 5))
        done
        log "  ✓ $ip:50000 is reachable"
      done
      
      log "All nodes are reachable!"
      
      log "Generating Talos configurations..."
      cd /root
      talosctl gen config "$CLUSTER_NAME" "$K8S_ENDPOINT" \
        --output-dir /root/talos-config \
        --with-docs=false \
        --with-examples=false
      
      log "✓ Talos configurations generated"
      
      # LIGNE CRITIQUE: Configurer les endpoints
      log "Configuring talosconfig endpoints..."
      talosctl --talosconfig /root/talos-config/talosconfig \
        config endpoint $${CONTROL_PLANE_IPS[@]}
      
      log "✓ Endpoints configured: $${CONTROL_PLANE_IPS[@]}"
      
      log "Applying Cilium patch..."
      talosctl machineconfig patch \
        /root/talos-config/controlplane.yaml \
        --patch @/root/cilium-patch.yaml \
        -o /root/talos-config/controlplane-patched.yaml
      
      log "✓ Cilium patch applied"
      
      log "Configuring control plane nodes..."
      for ip in "$${CONTROL_PLANE_IPS[@]}"; do
        log "  Configuring control plane: $ip"
        talosctl apply-config \
          --insecure \
          --nodes "$ip" \
          --file /root/talos-config/controlplane-patched.yaml
        log "  ✓ Control plane $ip configured"
      done
      
      log "Configuring worker nodes..."
      for ip in "$${WORKER_IPS[@]}"; do
        log "  Configuring worker: $ip"
        talosctl apply-config \
          --insecure \
          --nodes "$ip" \
          --file /root/talos-config/worker.yaml
        log "  ✓ Worker $ip configured"
      done
      
      log "Waiting 120 seconds for nodes to apply configuration..."
      sleep 120
      
      log "Bootstrapping etcd on first control plane..."
      talosctl bootstrap --nodes "$${CONTROL_PLANE_IPS[0]}"
      
      log "✓ etcd bootstrapped"
      
      log "Waiting 90 seconds for cluster to initialize..."
      sleep 90
      
      log "Fetching kubeconfig..."
      talosctl kubeconfig /root/talos-config/kubeconfig \
        --nodes "$${CONTROL_PLANE_IPS[0]}" \
        --force
      
      log "✓ Kubeconfig fetched"
      
      log "Checking cluster nodes..."
      export KUBECONFIG=/root/talos-config/kubeconfig
      kubectl get nodes -o wide || log "⚠️  Nodes not ready yet"
      
      log "Installing Cilium CNI..."
      helm repo add cilium https://helm.cilium.io/ 2>/dev/null || true
      helm repo update
      
      helm install cilium cilium/cilium \
        --namespace kube-system \
        --set ipam.mode=kubernetes \
        --set kubeProxyReplacement=true \
        --set k8sServiceHost=${k8s_api_endpoint} \
        --set k8sServicePort=6443
      
      log "✓ Cilium installed"
      
      log "Waiting for Cilium to be ready..."
      kubectl -n kube-system wait --for=condition=ready pod -l k8s-app=cilium --timeout=300s || {
        log "⚠️  Cilium pods not ready after 5 minutes"
      }
      
      log "=========================================="
      log "Bootstrap Complete!"
      log "=========================================="
      log ""
      log "Cluster Status:"
      kubectl get nodes -o wide
      log ""
      log "System Pods:"
      kubectl -n kube-system get pods
      log ""
      log "✅ Cluster is ready!"
      log ""
      log "To download configs to your local machine:"
      log "  scp -J bastion@51.158.99.238:61000 root@10.0.0.10:/root/talos-config/kubeconfig ~/.kube/${cluster_name}-config"
      log "  scp -J bastion@51.158.99.238:61000 root@10.0.0.10:/root/talos-config/talosconfig ~/.talos/${cluster_name}-config"
      log ""
      log "Then on your local machine:"
      log "  export KUBECONFIG=~/.kube/${cluster_name}-config"
      log "  export TALOSCONFIG=~/.talos/${cluster_name}-config"
      log ""
      log "=========================================="

  - path: /etc/systemd/system/talos-bootstrap.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Talos Cluster Bootstrap
      After=network-online.target
      Wants=network-online.target
      
      [Service]
      Type=oneshot
      User=root
      ExecStart=/root/bootstrap-talos.sh
      StandardOutput=journal+console
      StandardError=journal+console
      
      [Install]
      WantedBy=multi-user.target

runcmd:
  - |
    echo "Installing talosctl..."
    curl -sL https://talos.dev/install | sh
    talosctl version --client
  
  - |
    echo "Installing kubectl..."
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    chmod +x kubectl
    mv kubectl /usr/local/bin/
    kubectl version --client
  
  - |
    echo "Installing Helm..."
    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    helm version
  
  - systemctl daemon-reload
  - systemctl enable talos-bootstrap.service
  - systemctl start talos-bootstrap.service

final_message: |
  ========================================
  Bootstrap Bastion Ready!
  ========================================
  Talos cluster bootstrap is running in background.
  Check progress: journalctl -u talos-bootstrap -f
  Or view log: tail -f /var/log/talos-bootstrap.log
  ========================================
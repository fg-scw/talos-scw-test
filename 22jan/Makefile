# =============================================================================
# Talos Kubernetes on Scaleway - Makefile
# =============================================================================

.PHONY: help init build-minimal build-gpu build-all deploy destroy clean status logs download cleanup validate ssh plan

# Configuration
ZONE ?= fr-par-2
TALOS_VERSION ?= v1.12.1
CLUSTER_NAME ?= talos-k8s
GATEWAY_IP ?= $(shell cd terraform && terraform output -raw public_gateway_ip 2>/dev/null)
BASTION_PRIVATE_IP ?= $(shell cd terraform && terraform output -raw bastion_private_ip 2>/dev/null)

# Couleurs
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m

help:
	@echo ""
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë     Talos Kubernetes on Scaleway - GPU + MIG Ready            ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "üîß Setup:"
	@echo "  make init               - Initialize Packer and Terraform"
	@echo ""
	@echo "üèóÔ∏è  Build Images:"
	@echo "  make build-minimal      - Build Talos image for control plane & CPU workers"
	@echo "  make build-gpu          - Build Talos image for GPU workers (with NVIDIA)"
	@echo "  make build-all          - Build both images (required before deploy)"
	@echo ""
	@echo "üöÄ Deploy:"
	@echo "  make plan               - Terraform plan"
	@echo "  make deploy             - Deploy infrastructure with Terraform"
	@echo "  make all                - Build all images + Deploy infrastructure"
	@echo ""
	@echo "üìä Operations:"
	@echo "  make status             - Show bootstrap progress"
	@echo "  make logs               - Show full bootstrap logs"
	@echo "  make ssh                - SSH to bastion"
	@echo "  make download           - Download kubeconfig and talosconfig"
	@echo "  make validate           - Validate GPU node"
	@echo ""
	@echo "üßπ Cleanup:"
	@echo "  make cleanup            - Destroy bastion only (keep cluster)"
	@echo "  make destroy            - Destroy all infrastructure"
	@echo ""
	@echo "Note: Create .envrc from .envrc.example and run 'source .envrc'"
	@echo ""

# =============================================================================
# Initialization
# =============================================================================

init:
	@echo "$(GREEN)üîß Initializing Packer...$(NC)"
	cd packer && packer init .
	@echo "$(GREEN)üîß Initializing Terraform...$(NC)"
	cd terraform && terraform init
	@echo "$(GREEN)‚úÖ Initialization complete$(NC)"

# =============================================================================
# Image Building
# =============================================================================

build-minimal: 
	@echo "$(GREEN)üèóÔ∏è  Building Talos $(TALOS_VERSION) minimal image...$(NC)"
	cd packer && packer build \
		-var "zone=$(ZONE)" \
		-var "talos_version=$(TALOS_VERSION)" \
		-var "schematic_file=provision/schematic-minimal.yaml" \
		-var "image_suffix=-minimal" \
		-force \
		talos-scaleway.pkr.hcl
	@echo "$(GREEN)‚úÖ Minimal image built$(NC)"

build-gpu:
	@echo "$(GREEN)üèóÔ∏è  Building Talos $(TALOS_VERSION) GPU image (with NVIDIA extensions)...$(NC)"
	cd packer && packer build \
		-var "zone=$(ZONE)" \
		-var "talos_version=$(TALOS_VERSION)" \
		-var "schematic_file=provision/schematic-gpu.yaml" \
		-var "image_suffix=-gpu" \
		-force \
		talos-scaleway.pkr.hcl
	@echo "$(GREEN)‚úÖ GPU image built$(NC)"

build-all: build-minimal build-gpu
	@echo "$(GREEN)‚úÖ All Talos images built successfully$(NC)"

# =============================================================================
# Terraform Deployment
# =============================================================================

plan:
	cd terraform && terraform plan

deploy: init
	@echo "$(GREEN)üöÄ Deploying infrastructure...$(NC)"
	cd terraform && terraform apply -auto-approve
	@echo ""
	@echo "$(GREEN)‚úÖ Infrastructure deployed!$(NC)"
	@echo ""
	@echo "üìä Follow bootstrap: make status"
	@echo "üîë SSH to bastion:   make ssh"

# =============================================================================
# Full Deployment
# =============================================================================

all: build-all deploy
	@echo ""
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë          üéâ Complete Deployment Successful! üéâ                ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "üìä Follow bootstrap progress:"
	@echo "   make status"
	@echo ""

# =============================================================================
# Operations
# =============================================================================

ssh:
	@echo "$(GREEN)üîë Connecting to bastion...$(NC)"
	ssh -o StrictHostKeyChecking=no -J bastion@$(GATEWAY_IP):61000 root@$(BASTION_PRIVATE_IP)

status:
	@echo "$(GREEN)üìä Checking bootstrap status...$(NC)"
	ssh -o StrictHostKeyChecking=no -J bastion@$(GATEWAY_IP):61000 root@$(BASTION_PRIVATE_IP) \
		"journalctl -u talos-bootstrap.service -f"

logs:
	@echo "$(GREEN)üìã Fetching bootstrap logs...$(NC)"
	ssh -o StrictHostKeyChecking=no -J bastion@$(GATEWAY_IP):61000 root@$(BASTION_PRIVATE_IP) \
		"journalctl -u talos-bootstrap.service --no-pager"

download:
	@echo "$(GREEN)‚¨áÔ∏è  Downloading configurations...$(NC)"
	@mkdir -p ~/.kube ~/.talos
	scp -o StrictHostKeyChecking=no -o ProxyJump=bastion@$(GATEWAY_IP):61000 \
		root@$(BASTION_PRIVATE_IP):/root/talos-config/kubeconfig ~/.kube/$(CLUSTER_NAME)-config
	scp -o StrictHostKeyChecking=no -o ProxyJump=bastion@$(GATEWAY_IP):61000 \
		root@$(BASTION_PRIVATE_IP):/root/talos-config/talosconfig ~/.talos/$(CLUSTER_NAME)-config 2>/dev/null || true
	@echo ""
	@echo "$(GREEN)‚úÖ Configurations downloaded!$(NC)"
	@echo ""
	@echo "To use the cluster:"
	@echo "  export KUBECONFIG=~/.kube/$(CLUSTER_NAME)-config"
	@echo "  kubectl get nodes"

validate:
	@echo "$(GREEN)üîç Validating GPU node...$(NC)"
	@ssh -o StrictHostKeyChecking=no -J bastion@$(GATEWAY_IP):61000 root@$(BASTION_PRIVATE_IP) \
		'kubectl get nodes -o custom-columns="NAME:.metadata.name,GPU:.status.allocatable.nvidia\.com/gpu"'

# =============================================================================
# Cleanup
# =============================================================================

cleanup:
	@echo "$(YELLOW)üßπ Destroying bastion only...$(NC)"
	cd terraform && terraform destroy -target=scaleway_instance_server.bastion -auto-approve
	@echo "$(GREEN)‚úÖ Bastion destroyed. Cluster is still running.$(NC)"

destroy:
	@echo "$(RED)üí• Destroying all infrastructure...$(NC)"
	cd terraform && terraform destroy -auto-approve
	@echo "$(GREEN)‚úÖ All infrastructure destroyed$(NC)"

clean: destroy
	@echo "$(YELLOW)üßπ Cleaning local files...$(NC)"
	rm -rf terraform/.terraform terraform/terraform.tfstate* terraform/.terraform.lock.hcl
	rm -f packer/manifest.json
	@echo "$(GREEN)‚úÖ Clean complete$(NC)"
